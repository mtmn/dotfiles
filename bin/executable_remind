#!/bin/bash

# Simple reminder tool that stores reminders in a file and triggers notify-send alerts
# Usage: remind <time> "<message>"
# Examples: 
#   remind 30m "Take a break"
#   remind 18:50 "Time to leave"

# Configuration
REMINDER_FILE="$HOME/.reminders"
LOG_FILE="$HOME/.remind_history"

# Check if parameters are provided
if [ $# -lt 2 ]; then
    echo "Usage: remind <time> \"<message>\""
    echo "Time formats: 30s, 5m, 2h, 1d, or HH:MM"
    exit 1
fi

# Parse time and message
TIME="$1"
MESSAGE="$2"

# Check if the time is in HH:MM format
if [[ "$TIME" =~ ^([0-1][0-9]|2[0-3]):([0-5][0-9])$ ]]; then
    # Calculate seconds until the specified time
    CURRENT_TIME=$(date +%s)
    TARGET_TIME=$(date -d "$(date +%Y-%m-%d) $TIME" +%s)
    
    # If the target time is already passed for today, schedule for tomorrow
    if [ $TARGET_TIME -le $CURRENT_TIME ]; then
        TARGET_TIME=$(date -d "$(date -d 'tomorrow' +%Y-%m-%d) $TIME" +%s)
    fi
    
    SECONDS=$((TARGET_TIME - CURRENT_TIME))
    TRIGGER_TIME=$(date -d "@$TARGET_TIME" "+%Y-%m-%d %H:%M:%S")
    SLEEP_ARG="${SECONDS}s"
else
    # Handle relative time formats (30s, 5m, 2h, 1d)
    case "$TIME" in
        *s) SECONDS="${TIME%s}" ;;
        *m) SECONDS=$((${TIME%m} * 60)) ;;
        *h) SECONDS=$((${TIME%h} * 3600)) ;;
        *d) SECONDS=$((${TIME%d} * 86400)) ;;
        *) SECONDS="$TIME" ;;
    esac
    
    TRIGGER_TIME=$(date -d "+$SECONDS seconds" "+%Y-%m-%d %H:%M:%S")
    SLEEP_ARG="$TIME"
fi

# Create the reminder files if they don't exist
touch "$REMINDER_FILE"
touch "$LOG_FILE"

# Log the reminder
echo "[$TRIGGER_TIME] $MESSAGE" >> "$LOG_FILE"

# Schedule the notification
(
    sleep "$SLEEP_ARG" 
    notify-send -u critical "Reminder" "$MESSAGE"
    echo "Completed: [$TRIGGER_TIME] $MESSAGE" >> "$LOG_FILE"
    # Remove from active reminders file once completed
    sed -i "\|^\[$TRIGGER_TIME\] $MESSAGE$|d" "$REMINDER_FILE"
) &

# Show confirmation
echo "Reminder set for $TRIGGER_TIME: $MESSAGE"
echo "[$TRIGGER_TIME] $MESSAGE" >> "$REMINDER_FILE"
