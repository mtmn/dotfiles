#!/bin/bash

set -e

generate_choices() {
	local choices=(
		"buds"
		"sluch"
		"controller"
		"mouse"
		"off"
	)
	printf '%s\n' "${choices[@]}" | tr '\n' '\n' | sed ':a;N;$!ba;s/\n/\\n/g'
}

readonly choices
choices="$(generate_choices)"

connect_device() {
	local device_mac="$1"
	local device_name="$2"

	if [ -z "$device_mac" ]; then
		echo "Error: No MAC address provided for $device_name" >&2
		exit 1
	fi

	foot zsh -c "bluetoothctl -- power on && bluetoothctl connect '$device_mac'"
}

handle_bluetooth_control() {
	local device="$1"

	case "$device" in
	buds)
		connect_device "B8:7B:D4:19:2D:8D" "buds"
		;;
	sluch)
		connect_device "AC:BF:71:09:BF:FD" "sluch"
		;;
	controller)
		connect_device "98:7A:14:C9:9A:90" "controller"
		;;
	mouse)
		connect_device "D5:E4:1B:10:D6:75" "mouse"
		;;
	off)
		bluetoothctl -- power off
		;;
	*)
		echo "Error: Unknown device '$device'" >&2
		exit 1
		;;
	esac
}

main() {
	local chosen
	chosen=$(echo -e "$choices" | dmenu "$@")

	handle_bluetooth_control "$chosen"
}

main "$@"
