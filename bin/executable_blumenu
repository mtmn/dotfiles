#!/bin/bash

set -e

generate_choices() {
    local choices=(
        "buds"
        "sluch"
	"controller"
	"bit"
	"mouse"
	"off"
    )
    printf '%s\n' "${choices[@]}" | tr '\n' '\n' | sed ':a;N;$!ba;s/\n/\\n/g'
}

readonly CHOICES="$(generate_choices)"

readonly MAC_BUDS="B8:7B:D4:19:2D:8D"
readonly MAC_SLUCH="AC:BF:71:09:BF:FD"
readonly MAC_MOUSE="D5:E4:1B:10:D6:75"
readonly MAC_CONTROLLER="98:7A:14:C9:9A:90"
readonly MAC_BIT="98:7A:14:C9:9A:90"

connect_device() {
    local device_mac="$1"
    local device_name="$2"
    
    if [ -z "$device_mac" ]; then
        echo "Error: No MAC address provided for $device_name" >&2
        exit 1
    fi
    
    foot zsh -c "bluetoothctl -- power on && bluetoothctl connect '$device_mac'"
}

handle_bluetooth_control() {
    local device="$1"
    
    case "$device" in
        buds)
            connect_device "$MAC_BUDS" "buds"
            ;;
        sluch)
            connect_device "$MAC_SLUCH" "sluch"
            ;;
        controller)
            connect_device "$MAC_CONTROLLER" "controller"
            ;;
        bit)
            connect_device "$MAC_CONTROLLER" "bit"
            ;;
        mouse)
            connect_device "$MAC_MOUSE" "mouse"
            ;;
        off)
            bluetoothctl -- power off
            ;;
        *)
            echo "Error: Unknown device '$device'" >&2
            exit 1
            ;;
    esac
}

main() {
    local chosen
    chosen=$(echo -e "$CHOICES" | dmenu "$@")
    
    handle_bluetooth_control "$chosen"
}

main "$@"
