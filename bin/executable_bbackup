#!/bin/bash
declare -A dirs=(
	["nota"]="$HOME/misc/notes/nota"
	["obsidian"]="$HOME/misc/notes"
	["pass"]="$HOME/.password-store"
	["releases"]="$HOME/misc/notes/releases"
	["dotfiles"]="$HOME/.local/share/chezmoi"
)

PUSH_FLAG=false
BACKUP_TYPE=""

for arg in "$@"; do
	case "$arg" in
	--push)
		PUSH_FLAG=true
		;;
	*)
		if [[ -z "$BACKUP_TYPE" ]]; then
			BACKUP_TYPE="$arg"
		fi
		;;
	esac
done

git_backup() {
	local dir="$1"
	git --git-dir="$dir"/.git --work-tree="$dir" add -A >/dev/null
	git --git-dir="$dir"/.git --work-tree="$dir" commit -v
	if [[ "$PUSH_FLAG" == true ]]; then git --git-dir="$dir"/.git --work-tree="$dir" push; fi
}

self="$0"
backup_type="$1"

chezmoi_dir="$HOME/.local/share/chezmoi"
age_pub_key=$(<"$HOME"/misc/random/age.pub)

if [[ -z "$backup_type" ]]; then
	echo "Usage: $0 <backup_type>" >&2
	$self ls
	exit 1
fi

case "$backup_type" in
"all")
	for k in "${!dirs[@]}"; do
	    $self "$k"
	done
	$self magnolia
	;;
"push")
	for k in "${!dirs[@]}"; do
	    $self "$k" --push
	done
	;;
"ls")
	for k in "${!dirs[@]}"; do
	    echo "$k"
	done
	echo magnolia
	;;
"magnolia")
	age -r "$age_pub_key" "$HOME"/.magnolia.db >"$chezmoi_dir"/encrypted_dot_magnolia.db.age
	chmod 644 "$chezmoi_dir"/encrypted_dot_magnolia.db.age
	git --git-dir="$chezmoi_dir"/.git --work-tree="$chezmoi_dir" add -A >/dev/null
	git --git-dir="$chezmoi_dir"/.git --work-tree="$chezmoi_dir" commit -m "chore: magnolia.db"
	if [[ "$PUSH_FLAG" == true ]]; then git --git-dir="$dir"/.git --work-tree="$dir" push; fi
	;;
*)
	if [[ -n "${dirs[$backup_type]}" ]]; then
		echo "Backing up $backup_type"
		git_backup "${dirs[$backup_type]}"
	fi
	;;
esac
