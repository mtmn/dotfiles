#!/bin/bash
set -euo pipefail

export PASSWORD_STORE_CLIP_TIME=60
shopt -s nullglob globstar

prefix="${PASSWORD_STORE_DIR:-$HOME/.password-store}"
prefix="${prefix%/}/"

if [ ! -d "$prefix" ]; then
    echo "Error: Password store '$prefix' not found" >&2
    exit 1
fi

password_files=( "$prefix"**/*.gpg )
password_files=( "${password_files[@]#"$prefix"}" )
password_files=( "${password_files[@]%.gpg}" )

password=$(printf '%s\n' "${password_files[@]}" | fuzzel --dmenu "$@")
[ -z "$password" ] && exit 0

if [[ "$password" == *otp* ]]; then
    pass otp -c "$password" >/dev/null 2>&1
else
    pass show -c "$password" >/dev/null 2>&1
fi
